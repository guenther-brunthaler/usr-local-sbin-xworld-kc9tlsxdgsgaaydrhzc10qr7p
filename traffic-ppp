#! /bin/sh
# Add the sent/received bytes from the pppd syslog entries together for the
# current day and show the traffic sum.
#
# This script assumes a syslog format starting using YYYY-MM-DD format as the
# line prefix.
#
# If an argument is specified, it specifies an integral number of days and the
# sum will be calculated instead for the date that many day before the current
# day.
#
# Version 17.168
# Copyright (c) 2017 Guenther Brunthaler. All rights reserved.
# 
# This script is free software.
# Distribution is permitted under the terms of the GPLv3.
set -e
trap 'test $? = 0 || echo "$0 failed!" >& 2' 0
precise=false
while getopts p opt
do
	case $opt in
		p) precise=true;;
		*) false || exit
	esac
done
shift `expr $OPTIND - 1 || :`

date=`date +%s`
if test $# = 1
then
	expr x"$1" : x'[1-9][0-9]*$' > /dev/null
	date=`expr $date - 60 \* 60 \* 24 \* $1`
else
	test $# = 0
fi
date=`date -d "@$date" +%Y-%m-%d`
if $precise
then
	pid=`pidof pppd`
	test "`echo "$pid" | tr ' ' '\n' | wc -l`" = 1
	# Terminate the connection, adding the statistics for it to the
	# syslog. In case of "persist" and "demand" connections, this will
	# *not* reset the package counters or remove the interface
	# temporarily.
	kill -HUP $pid
fi
decimal_point=.
eval `locale -k LC_NUMERIC | grep ^decimal_point=` 2> /dev/null || :
logread | grep "^$date" | grep 'Sent.*received.*bytes' | sed '
	s/\([0-9]*\) bytes/<<\1>>/g
	s/[^<]*<<//
	s/[^0-9]\{1,\}/\n/g
' | sed '/^[^0-9]*$/d' | awk '
	BEGIN {s= 0}
	{s+= $0}
	END {
		split("K M G T P E Z Y", u)
		for (i in u) u[i]= u[i] "iB"
		u[i= 0]= "bytes"
		while (s >= 1024 && i + 1 in u) {
			++i; s/= 1024
		}
		split(sprintf("%.2f", s), v, "[.]")
		v[3]= v[2] == 0 ? "" : v[2]
		v[2]= v[3] == "" ? "" : "."
		v[4]= " "; v[5]= u[i]
		s= ""
		for (i in v) s= s v[i]
		print s
	}
' | tr . "$decimal_point" | sed 's/^/'"$date: "'/'
